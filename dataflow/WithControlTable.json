{
	"name": "WithControlTable",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "AzureSqlTable1",
						"type": "DatasetReference"
					},
					"name": "SourceAreaCDC"
				},
				{
					"dataset": {
						"referenceName": "AzureSqlTable2",
						"type": "DatasetReference"
					},
					"name": "ExistingArea"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "AzureSqlTable2",
						"type": "DatasetReference"
					},
					"name": "SinkAreaDim"
				}
			],
			"transformations": [
				{
					"name": "LookupExistingRecords"
				},
				{
					"name": "AddReqCol"
				},
				{
					"name": "InsertUpdate"
				},
				{
					"name": "FilterCDCRecords"
				}
			],
			"scriptLines": [
				"parameters{",
				"     LastRunTime as timestamp (toTimestamp('1900-01-01 00:00:00'))",
				"}",
				"source(output(",
				"          Business_Unit_ID as integer,",
				"          Business_Unit as string,",
				"          Block_ID as string,",
				"          Area_Classification_1 as string,",
				"          Area_Classification_2 as string,",
				"          Plant_ID as string,",
				"          Plant_ID2 as string,",
				"          Asset_Owner as string,",
				"          Cost_Center as string,",
				"          Tier_Classification as string,",
				"          Comments as string,",
				"          Business_Justification as string,",
				"          Attachments as string,",
				"          Field_Engineer as string,",
				"          Field_Engineer_Remarks as string,",
				"          Approver_1_Name as string,",
				"          Approver_1_Remarks as string,",
				"          Approver_1_Timestamp as timestamp,",
				"          Approver_2_Name as string,",
				"          Approver_2_Remarks as string,",
				"          Approver_2_Timestamp as timestamp,",
				"          Created_By as string,",
				"          Created_Timestamp as timestamp,",
				"          Updated_By as string,",
				"          Updated_Timestamp as timestamp",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> SourceAreaCDC",
				"source(output(",
				"          Business_Unit as string,",
				"          Block_ID as string,",
				"          Area_Classification_1 as string,",
				"          Area_Classification_2 as string,",
				"          Plant_ID as string,",
				"          Plant_ID2 as string,",
				"          Asset_Owner as string,",
				"          Cost_Center as string,",
				"          Tier_Classification as string,",
				"          Comments as string,",
				"          Business_Justification as string,",
				"          Attachments as string,",
				"          Begin_Date as date,",
				"          End_Date as date,",
				"          Current_Rec_In as integer,",
				"          Field_Engineer_Name as string,",
				"          Field_Engineer_Remarks as string,",
				"          Approver_1_Name as string,",
				"          Approver_1_Remarks as string,",
				"          Approver_1_Timestamp as timestamp,",
				"          Approver_2_Name as string,",
				"          Approver_2_Remarks as string,",
				"          Approver_2_Timestamp as timestamp,",
				"          Created_By as string,",
				"          Created_Timestamp as timestamp,",
				"          Updated_By as string,",
				"          Updated_Timestamp as timestamp,",
				"          Business_Unit_ID as integer,",
				"          Business_Unit_Key as integer",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> ExistingArea",
				"FilterCDCRecords, ExistingArea lookup(SourceAreaCDC@Business_Unit_ID == ExistingArea@Business_Unit_ID,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'auto')~> LookupExistingRecords",
				"LookupExistingRecords derive(Field_Engineer_Name = Field_Engineer,",
				"          Begin_Date = currentDate(),",
				"          End_Date = toDate('9999-12-31'),",
				"          Current_Rec_In = 1) ~> AddReqCol",
				"AddReqCol alterRow(insertIf(!isNull(ExistingArea@Business_Unit_ID)),",
				"     updateIf(!isNull(ExistingArea@Business_Unit_ID))) ~> InsertUpdate",
				"SourceAreaCDC filter(Created_Timestamp > $LastRunTime || Updated_Timestamp > $LastRunTime",
				") ~> FilterCDCRecords",
				"InsertUpdate sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          Business_Unit as string,",
				"          Block_ID as string,",
				"          Area_Classification_1 as string,",
				"          Area_Classification_2 as string,",
				"          Plant_ID as string,",
				"          Plant_ID2 as string,",
				"          Asset_Owner as string,",
				"          Cost_Center as string,",
				"          Tier_Classification as string,",
				"          Comments as string,",
				"          Business_Justification as string,",
				"          Attachments as string,",
				"          Begin_Date as date,",
				"          End_Date as date,",
				"          Current_Rec_In as integer,",
				"          Field_Engineer_Name as string,",
				"          Field_Engineer_Remarks as string,",
				"          Approver_1_Name as string,",
				"          Approver_1_Remarks as string,",
				"          Approver_1_Timestamp as timestamp,",
				"          Approver_2_Name as string,",
				"          Approver_2_Remarks as string,",
				"          Approver_2_Timestamp as timestamp,",
				"          Created_By as string,",
				"          Created_Timestamp as timestamp,",
				"          Updated_By as string,",
				"          Updated_Timestamp as timestamp,",
				"          Business_Unit_ID as integer,",
				"          Business_Unit_Key as integer",
				"     ),",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:true,",
				"     upsertable:false,",
				"     keys:['Business_Unit_ID'],",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          Business_Unit = SourceAreaCDC@Business_Unit,",
				"          Block_ID = SourceAreaCDC@Block_ID,",
				"          Area_Classification_1 = SourceAreaCDC@Area_Classification_1,",
				"          Area_Classification_2 = SourceAreaCDC@Area_Classification_2,",
				"          Plant_ID = SourceAreaCDC@Plant_ID,",
				"          Plant_ID2 = SourceAreaCDC@Plant_ID2,",
				"          Asset_Owner = SourceAreaCDC@Asset_Owner,",
				"          Cost_Center = SourceAreaCDC@Cost_Center,",
				"          Tier_Classification = SourceAreaCDC@Tier_Classification,",
				"          Comments = SourceAreaCDC@Comments,",
				"          Business_Justification = SourceAreaCDC@Business_Justification,",
				"          Attachments = SourceAreaCDC@Attachments,",
				"          Begin_Date,",
				"          End_Date,",
				"          Current_Rec_In,",
				"          Field_Engineer_Name,",
				"          Field_Engineer_Remarks = SourceAreaCDC@Field_Engineer_Remarks,",
				"          Approver_1_Name = SourceAreaCDC@Approver_1_Name,",
				"          Approver_1_Remarks = SourceAreaCDC@Approver_1_Remarks,",
				"          Approver_1_Timestamp = SourceAreaCDC@Approver_1_Timestamp,",
				"          Approver_2_Name = SourceAreaCDC@Approver_2_Name,",
				"          Approver_2_Remarks = SourceAreaCDC@Approver_2_Remarks,",
				"          Approver_2_Timestamp = SourceAreaCDC@Approver_2_Timestamp,",
				"          Created_By = SourceAreaCDC@Created_By,",
				"          Created_Timestamp = SourceAreaCDC@Created_Timestamp,",
				"          Updated_By = SourceAreaCDC@Updated_By,",
				"          Updated_Timestamp = SourceAreaCDC@Updated_Timestamp,",
				"          Business_Unit_ID = SourceAreaCDC@Business_Unit_ID",
				"     )) ~> SinkAreaDim"
			]
		}
	}
}